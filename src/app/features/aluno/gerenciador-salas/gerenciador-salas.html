<ng-container *ngIf="{ canManage: (authService.isAdmin$ | async) } as perms">

  <div class="container-fluid my-5 px-lg-5">
    <div class="row g-4">
          
      <div class="mb-4 text-center">
        <app-profile-switcher></app-profile-switcher>
      </div>
      <!-- Coluna da Esquerda: Painel de Controle e Formulários -->
      <div class="col-lg-4 col-xl-3">
        <div class="control-panel">
          <header class="text-center mb-4">
            <h1 class="h4 fw-bold text-success">{{ perms.canManage ? 'Planta do Campus' : 'Mapa do Campus' }}</h1>
            <p class="text-muted small">{{ perms.canManage ? 'Gerencie blocos e salas.' : 'Explore os blocos e salas.' }}</p>
          </header>
          
          <div *ngIf="error" class="alert alert-danger alert-dismissible fade show" role="alert">
            {{ error }}
            <button type="button" class="btn-close" (click)="error = null" aria-label="Close"></button>
          </div>

          <!-- Formulários para Admin -->
          <div *ngIf="perms.canManage">
            <!-- Formulário de Bloco -->
            <div class="card card-body mb-3 shadow-sm">
              <form #blocoForm="ngForm" (ngSubmit)="handleCreateBloco()">
                <h3 class="h6 text-success border-bottom pb-2 mb-3">Criar Novo Bloco</h3>
                <div class="mb-3">
                  <label for="blockName" class="form-label small">Nome do Bloco</label>
                  <input type="text" id="blockName" class="form-control" [(ngModel)]="novoBlocoNome" name="novoBlocoNome" placeholder="Ex: Bloco Didático I" required>
                </div>
                <button type="submit" class="btn btn-success w-100" [disabled]="blocoForm.invalid">
                  <i class="bi bi-plus-circle me-2"></i>Adicionar Bloco
                </button>
              </form>
            </div>

            <!-- Formulário de Sala -->
            <div class="card card-body shadow-sm">
              <form #salaForm="ngForm" (ngSubmit)="handleSubmitSala()">
                <h3 class="h6 text-success border-bottom pb-2 mb-3">{{ editingSala ? 'Editar Sala' : 'Adicionar Nova Sala' }}</h3>

                <div class="mb-3">
                  <label for="blockSelect" class="form-label small">Bloco</label>
                  <select id="blockSelect" class="form-select" [(ngModel)]="blocoSelecionadoId" name="blocoSelecionadoId" [disabled]="blocos.length === 0 || !!editingSala" required>
                    <option *ngIf="blocos.length === 0" [ngValue]="null">Crie um bloco primeiro</option>
                    <option *ngFor="let bloco of blocos" [value]="bloco.id">{{ bloco.nome }}</option>
                  </select>
                </div>

                <div class="row g-2 mb-3">
                  <div class="col-sm-8">
                    <label for="roomCode" class="form-label small">Código da Sala</label>
                    <input type="text" id="roomCode" class="form-control" [(ngModel)]="formSala.codigo" name="salaCodigo" required>
                  </div>
                  <div class="col-sm-4">
                    <label for="roomCapacity" class="form-label small">Capacidade</label>
                    <input type="number" id="roomCapacity" class="form-control" [(ngModel)]="formSala.capacidade" name="salaCapacidade" required>
                  </div>
                </div>

                <p class="small text-muted mb-2">Posicionamento e Dimensões</p>
                <div class="row g-2">
                  <div class="col-3"><input type="number" placeholder="X" title="Pos. X" class="form-control" [(ngModel)]="formSala.posX" name="salaPosX" required></div>
                  <div class="col-3"><input type="number" placeholder="Y" title="Pos. Y" class="form-control" [(ngModel)]="formSala.posY" name="salaPosY" required></div>
                  <div class="col-3"><input type="number" placeholder="Larg." title="Largura" class="form-control" [(ngModel)]="formSala.largura" name="salaLargura" required></div>
                  <div class="col-3"><input type="number" placeholder="Alt." title="Altura" class="form-control" [(ngModel)]="formSala.altura" name="salaAltura" required></div>
                </div>

                <div class="d-flex flex-wrap gap-2 mt-4">
                  <button type="submit" class="btn btn-success flex-grow-1" [disabled]="salaForm.invalid">
                    <i class="bi me-2" [ngClass]="editingSala ? 'bi-check-circle' : 'bi-plus-circle'"></i>
                    {{ editingSala ? 'Atualizar Sala' : 'Adicionar Sala' }}
                  </button>
                  <button *ngIf="editingSala" type="button" class="btn btn-warning" (click)="resetPosition()" title="Resetar Posição">
                    <i class="bi bi-arrow-counterclockwise"></i>
                  </button>
                  <button *ngIf="editingSala" type="button" class="btn btn-secondary" (click)="cancelarEdicao()">
                    Cancelar
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Coluna da Direita: Lista de Blocos e Mapa -->
      <div class="col-lg-8 col-xl-9">
        <main>
          <div *ngIf="!perms.canManage" class="alert alert-info text-center">
            <h2 class="h6 mb-1"><i class="bi bi-map-fill me-2"></i>Explore o Campus!</h2>
            <p class="small mb-0">Clique em um bloco para ver as salas. Use o scroll na planta para dar zoom e arraste para navegar.</p>
          </div>

          <div class="accordion" id="blocosAccordion">
            <div *ngIf="blocos.length === 0" class="text-center p-5 text-muted">
              <i class="bi bi-diagram-3-fill fs-1"></i>
              <p class="mt-2">Nenhum bloco encontrado.</p>
              <p *ngIf="perms.canManage">Use o painel ao lado para criar o primeiro bloco.</p>
            </div>

            <div *ngFor="let bloco of blocos" class="accordion-item shadow-sm">
              <h2 class="accordion-header" [id]="'heading' + bloco.id">
                <button class="accordion-button" type="button" [class.collapsed]="activeBlocoId !== bloco.id" (click)="toggleBloco(bloco.id!)">
                  {{ bloco.nome }}
                </button>
              </h2>
              <div [id]="'collapse' + bloco.id" class="accordion-collapse collapse" [class.show]="activeBlocoId === bloco.id">
                <div class="accordion-body">
                  <!-- Dicas e Infos -->
                  <div *ngIf="bloco.salas && bloco.salas.length > 0">
                    <div class="alert alert-light text-center p-2 small mb-3">
                      <i class="bi bi-info-circle me-1"></i>
                      <span *ngIf="perms.canManage"><b>Dica:</b> Clique e arraste uma sala para movê-la. Clique novamente para editar.</span>
                      <span *ngIf="!perms.canManage"><b>Dica:</b> Use o scroll do mouse para dar zoom e arraste para navegar no mapa.</span>
                    </div>

                    <div *ngIf="editingSala" class="selected-sala-info alert alert-success d-flex justify-content-between align-items-center">
                      <div>
                        <strong>Editando Sala:</strong> {{ editingSala.codigo }}
                      </div>
                      <button class="btn btn-sm btn-outline-danger" (click)="handleDeleteSala(bloco.id!, editingSala.id!)">
                        <i class="bi bi-trash me-2"></i>Excluir
                      </button>
                    </div>
                  </div>

                  <!-- Mapa -->
                  <div *ngIf="bloco.salas && bloco.salas.length > 0; else noRooms" class="floorplan-wrapper">
                    <div class="floorplan-container" [class.is-dragging]="isDragging">
                      <ngx-pan-zoom [config]="panZoomConfig" (wheel)="$event.preventDefault()">
                        <svg class="floorplan-svg" viewBox="0 0 1600 900">
                          <g *ngFor="let sala of bloco.salas"
                            (mousedown)="perms.canManage ? onMouseDown($event, sala) : null"
                            (click)="perms.canManage ? selectSala(sala) : null"
                            class="sala-group"
                            [class.dragging]="draggingSala?.id === sala.id"
                            [class.clickable-for-user]="!perms.canManage">

                            <rect [attr.x]="sala.posX ?? 0" [attr.y]="sala.posY ?? 0" [attr.width]="sala.largura ?? 150" [attr.height]="sala.altura ?? 100" class="sala-rect" [class.editing]="editingSala?.id === sala.id"></rect>
                            <text [attr.x]="(sala.posX ?? 0) + (sala.largura ?? 150) / 2" [attr.y]="(sala.posY ?? 0) + (sala.altura ?? 100) / 2" class="sala-text">
                              <tspan class="sala-codigo">{{ sala.codigo }}</tspan>
                              <tspan [attr.x]="(sala.posX ?? 0) + (sala.largura ?? 150) / 2" dy="1.2em" class="sala-capacidade">Cap: {{ sala.capacidade }}</tspan>
                            </text>
                          </g>
                        </svg>
                      </ngx-pan-zoom>
                    </div>
                  </div>

                  <ng-template #noRooms>
                    <div class="text-center p-5 text-muted">
                       <i class="bi bi-door-closed-fill fs-1"></i>
                      <p class="mt-2">{{ perms.canManage ? 'Nenhuma sala adicionada a este bloco.' : 'Nenhuma sala encontrada neste bloco.' }}</p>
                       <p *ngIf="perms.canManage" class="small">Use o painel de controle para adicionar a primeira sala.</p>
                    </div>
                  </ng-template>

                  <!-- Botão de Excluir Bloco -->
                  <div *ngIf="perms.canManage && !editingSala" class="mt-4 pt-3 border-top text-end">
                    <button (click)="handleDeleteBloco(bloco.id!)" class="btn btn-sm btn-outline-danger">
                      <i class="bi bi-trash me-2"></i>Excluir Bloco "{{ bloco.nome }}"
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>
  </div>
</ng-container>