<ng-container *ngIf="{ canManage: (authService.isCoordenador$ | async) } as perms">

  <div class="container my-4">
    <app-profile-switcher></app-profile-switcher>

    <div class="d-flex justify-content-between align-items-center my-4">
      <h1 class="h2 fw-bold mb-0" style="color: #333;">
        {{ authService.isRoleActiveOrHigher('ROLE_COORDENADOR') ? 'Gerenciar Cursos' : 'Catálogo de Cursos' }}
      </h1>
      <button class="btn btn-success btn-lg shadow-sm" (click)="abrirModal()" *ngIf="authService.isRoleActiveOrHigher('ROLE_COORDENADOR')">
        <i class="bi bi-plus-lg me-2"></i>Novo Curso
      </button>
    </div>

    <!-- Dashboard de Estatísticas -->
    <app-dashboard-stats
       [stats]="statsCards"
       *ngIf="!isLoadingStats && statsCards.length > 0">
    </app-dashboard-stats>

    <!-- Loading das estatísticas -->
    <div *ngIf="isLoadingStats" class="text-center py-3 mb-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Carregando estatísticas...</span>
      </div>
    </div>

    <!-- Busca Simples -->
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="input-group">
          <span class="input-group-text">
            <i class="bi bi-search"></i>
          </span>
          <input
            type="text"
            class="form-control"
            placeholder="Pesquisar por nome, código, departamento..."
            [(ngModel)]="termoBusca">
        </div>
      </div>
    </div>

    <div *ngIf="isLoading" class="text-center py-5">
      <div class="spinner-border text-success" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Carregando...</span>
      </div>
    </div>

    <div *ngIf="!isLoading && cursos.length === 0" class="text-center py-5">
      <div class="display-4 text-muted mb-3">
        <i class="bi bi-mortarboard-fill"></i>
      </div>
      <h4 class="text-muted">Nenhum curso encontrado</h4>
      <p *ngIf="termoBusca" class="text-muted">Tente um termo de busca diferente.</p>
    </div>

    <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4">
      <div class="col" *ngFor="let curso of cursos | filter:termoBusca:'nome,codigo,departamento,descricao'">
        <div class="curso-card"
             [class.featured]="curso.cargaHoraria > 100"
             [class.high-workload]="curso.cargaHoraria > 120"
             [class.low-workload]="curso.cargaHoraria < 60">

          <!-- Status Badge -->
          <div class="status-badge"
               [class.popular]="curso.cargaHoraria > 100"
               [class.intensive]="curso.cargaHoraria > 120"
               [class.new]="curso.cargaHoraria < 60">
            {{ curso.cargaHoraria > 120 ? 'Intensivo' : curso.cargaHoraria > 100 ? 'Popular' : 'Básico' }}
          </div>

          <div class="curso-card-header">
            <h5 class="curso-nome">{{ curso.nome }}</h5>
            <span class="curso-badge">{{ curso.codigo }}</span>
          </div>

          <div class="curso-card-body">
            <p class="curso-descricao">{{ curso.descricao | slice:0:100 }}{{ curso.descricao && curso.descricao.length > 100 ? '...' : '' }}</p>

            <div class="curso-info">
              <span><i class="bi bi-clock-history me-2"></i>{{ curso.cargaHoraria }}h</span>
              <span><i class="bi bi-building me-2"></i>{{ curso.departamento }}</span>
            </div>

            <!-- Meta informações adicionais -->
            <div class="curso-meta">
              <div class="meta-item">
                <i class="bi bi-calendar-check"></i>
                <span>Ativo</span>
              </div>
              <div class="meta-item" *ngIf="curso.cargaHoraria > 80">
                <i class="bi bi-star-fill"></i>
                <span>Destaque</span>
              </div>
              <div class="meta-item">
                <i class="bi bi-people"></i>
                <span>Curso completo</span>
              </div>
            </div>
          </div>

          <div class="curso-card-footer">
            <button class="btn-acao ver"
                    (click)="verDetalhes(curso)"
                    data-bs-toggle="tooltip"
                    data-bs-placement="top"
                    title="Ver detalhes completos do curso">
              <i class="bi bi-eye-fill"></i>
            </button>
            <ng-container *ngIf="authService.isRoleActiveOrHigher('ROLE_COORDENADOR')">
              <button class="btn-acao editar"
                      (click)="abrirModal(curso)"
                      data-bs-toggle="tooltip"
                      data-bs-placement="top"
                      title="Editar informações do curso">
                <i class="bi bi-pencil-fill"></i>
              </button>
              <button class="btn-acao deletar"
                      (click)="confirmarDelecao(curso)"
                      data-bs-toggle="tooltip"
                      data-bs-placement="top"
                      title="Excluir curso permanentemente">
                <i class="bi bi-trash-fill"></i>
              </button>
            </ng-container>
          </div>

          <!-- Preview Card (aparece no hover) -->
          <div class="curso-card-preview">
            <div class="preview-title">{{ curso.nome }}</div>
            <div class="preview-stats">
              <div class="preview-stat">
                <div class="preview-stat-value">{{ curso.cargaHoraria }}</div>
                <div class="preview-stat-label">Horas</div>
              </div>
              <div class="preview-stat">
                <div class="preview-stat-value">{{ curso.departamento }}</div>
                <div class="preview-stat-label">Departamento</div>
              </div>
            </div>
            <div class="preview-description">
              {{ curso.descricao || 'Sem descrição disponível' }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-container>

<!-- Modal Criar/Editar Curso -->
<div class="modal fade" [class.show]="isModalOpen" [style.display]="isModalOpen ? 'block' : 'none'" (click)="onBackdropClick($event)">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ isEditing ? 'Editar' : 'Novo' }} Curso</h5>
        <button type="button" class="btn-close" (click)="fecharModal()"></button>
      </div>
      <div class="modal-body">
        <form [formGroup]="cursoForm" (ngSubmit)="salvarCurso()">
          <div class="row">
            <div class="col-md-8 mb-3">
              <label for="nome" class="form-label">Nome do Curso</label>
              <input type="text" id="nome" class="form-control" formControlName="nome" required>
            </div>
            <div class="col-md-4 mb-3">
              <label for="codigo" class="form-label">Código</label>
              <input type="text" id="codigo" class="form-control" formControlName="codigo" required>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
                <label for="cargaHoraria" class="form-label">Carga Horária (h)</label>
                <input type="number" id="cargaHoraria" class="form-control" formControlName="cargaHoraria" min="1" required>
            </div>
            <div class="col-md-6 mb-3">
                <label for="departamento" class="form-label">Departamento</label>
                <select id="departamento" class="form-select" formControlName="departamento" required>
                    <option [ngValue]="null" disabled>Selecione</option>
                    <option *ngFor="let dep of departamentosDisponiveis" [value]="dep">{{ dep }}</option>
                </select>
            </div>
          </div>
          <div class="mb-3">
            <label for="descricao" class="form-label">Descrição</label>
            <textarea id="descricao" class="form-control" formControlName="descricao" rows="4"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="fecharModal()">Cancelar</button>
        <button type="button" class="btn btn-success" [disabled]="cursoForm.invalid" (click)="salvarCurso()">
          <i class="bi bi-save me-1"></i> {{ isEditing ? 'Atualizar' : 'Salvar' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Detalhes -->
<div class="modal fade" [class.show]="cursoDetalhes" [style.display]="cursoDetalhes ? 'block' : 'none'" (click)="fecharDetalhes()">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ cursoDetalhes?.nome }}</h5>
                <button type="button" class="btn-close" (click)="fecharDetalhes()"></button>
            </div>
            <div class="modal-body">
                <p><strong>Código:</strong> {{ cursoDetalhes?.codigo }}</p>
                <p><strong>Carga Horária:</strong> {{ cursoDetalhes?.cargaHoraria }}h</p>
                <p><strong>Departamento:</strong> {{ cursoDetalhes?.departamento }}</p>
                <hr>
                <p>{{ cursoDetalhes?.descricao }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmação Deleção -->
<div class="modal fade" [class.show]="cursoParaDeletar" [style.display]="cursoParaDeletar ? 'block' : 'none'" (click)="fecharModalDelecao()">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Exclusão</h5>
                <button type="button" class="btn-close" (click)="fecharModalDelecao()"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir o curso <strong>{{ cursoParaDeletar?.nome }}</strong>?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="fecharModalDelecao()">Cancelar</button>
                <button type="button" class="btn btn-danger" (click)="deletarCurso()">Excluir</button>
            </div>
        </div>
    </div>
</div>