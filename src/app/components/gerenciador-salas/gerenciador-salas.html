<div class="container my-5">
    <header class="text-center mb-5">
        <h1 class="display-5 fw-bold text-success">Planta do Campus</h1>
        <p class="text-muted fs-5">Visualize e gerencie os blocos e salas da instituição.</p>
    </header>

    <div *ngIf="error" class="alert alert-danger alert-dismissible fade show" role="alert">
        {{ error }}
        <button type="button" class="btn-close" (click)="error = null" aria-label="Close"></button>
    </div>

    <!-- PAINEL DO ADMINISTRADOR -->
    <section *ngIf="isAdmin" class="card card-body mb-5 shadow-sm border-0 rounded-4">
      <h2 class="h4 border-bottom pb-3 mb-4 text-success">Painel de Controle</h2>
      <div class="row g-4">
        <div class="col-md-6">
            <form #blocoForm="ngForm" (ngSubmit)="handleCreateBloco()">
              <h3 class="h5">Criar Novo Bloco</h3>
              <div class="mb-3">
                  <label for="blockName" class="form-label">Nome do Bloco</label>
                  <input type="text" id="blockName" class="form-control" [(ngModel)]="novoBlocoNome" name="novoBlocoNome" placeholder="Ex: Bloco Didático I" required>
              </div>
              <button type="submit" class="btn btn-success w-100" [disabled]="blocoForm.invalid">Adicionar Bloco</button>
            </form>
        </div>
        <div class="col-md-6">
            <form #salaForm="ngForm" (ngSubmit)="handleCreateSala()">
              <h3 class="h5">Adicionar Sala</h3>
              <div class="mb-3">
                  <label for="blockSelect" class="form-label">Selecione o Bloco</label>
                  <select id="blockSelect" class="form-select" [(ngModel)]="blocoSelecionadoId" name="blocoSelecionadoId" [disabled]="blocos.length === 0" required>
                    <option *ngIf="blocos.length === 0" [ngValue]="null">Crie um bloco primeiro</option>
                    <option *ngFor="let bloco of blocos" [value]="bloco.id">{{ bloco.nome }}</option>
                  </select>
              </div>
              <div class="row g-2">
                <div class="col-sm-8">
                    <label for="roomCode" class="form-label">Código da Sala</label>
                    <input type="text" id="roomCode" class="form-control" [(ngModel)]="novaSalaCodigo" name="novaSalaCodigo" placeholder="Ex: S-203" required>
                </div>
                <div class="col-sm-4">
                    <label for="roomCapacity" class="form-label">Capacidade</label>
                    <input type="number" id="roomCapacity" class="form-control" [(ngModel)]="novaSalaCapacidade" name="novaSalaCapacidade" placeholder="Ex: 40" required>
                </div>
              </div>
              <button type="submit" class="btn btn-primary w-100 mt-3" [disabled]="salaForm.invalid">Adicionar Sala</button>
            </form>
        </div>
      </div>
    </section>

    <!-- EXIBIÇÃO DA PLANTA -->
    <main>
        <div *ngIf="isLoading" class="text-center p-5">
            <div class="spinner-border text-success" style="width: 3rem; height: 3rem;" role="status"><span class="visually-hidden">Carregando...</span></div>
        </div>

        <div *ngIf="!isLoading && !error && blocos.length === 0" class="text-center card card-body p-5 rounded-4 border-dashed">
            <h3 class="h5">Nenhum bloco encontrado.</h3>
            <p class="text-muted" *ngIf="isAdmin">Use o painel de controle acima para começar a construir a planta.</p>
            <p class="text-muted" *ngIf="!isAdmin">A planta do campus ainda não foi configurada.</p>
        </div>
        
        <div class="accordion" id="blocosAccordion">
            <div *ngFor="let bloco of blocos" class="accordion-item shadow-sm">
                <h2 class="accordion-header" [id]="'heading' + bloco.id">
                    <button class="accordion-button" type="button" [class.collapsed]="activeBlocoId !== bloco.id" (click)="toggleBloco(bloco.id)">
                        {{ bloco.nome }}
                    </button>
                </h2>
                <div [id]="'collapse' + bloco.id" class="accordion-collapse collapse" [class.show]="activeBlocoId === bloco.id">
                    <div class="accordion-body">
                        
                        <!-- ATUALIZADO: Layout de Mapa com CSS Grid e número de linhas dinâmico -->
                        <div *ngIf="bloco.salasComLayout && bloco.salasComLayout.length > 0; else noRooms" 
                             class="bloco-mapa" 
                             [style.grid-template-rows]="bloco.gridRows">
                            
                            <div class="corredor-mapa-item"></div>
                            
                            <div *ngFor="let sala of bloco.salasComLayout"
                                 class="sala-mapa-item"
                                 [style.grid-area]="sala.gridArea">
                                
                                <span class="fw-bold d-block">{{ sala.codigo }}</span>
                                <small class="text-muted">Cap: {{ sala.capacidade }}</small>
                                
                                <button *ngIf="isAdmin" (click)="handleDeleteSala(bloco.id, sala.id)" class="btn btn-close btn-sm position-absolute top-0 end-0 m-1" aria-label="Close"></button>
                            </div>
                        </div>

                        <ng-template #noRooms>
                            <p class="text-center text-muted fst-italic p-4">Nenhuma sala adicionada a este bloco.</p>
                        </ng-template>

                        <div *ngIf="isAdmin" class="mt-4 pt-3 border-top text-end">
                            <button (click)="handleDeleteBloco(bloco.id)" class="btn btn-sm btn-outline-danger">
                                Excluir Bloco "{{ bloco.nome }}"
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>